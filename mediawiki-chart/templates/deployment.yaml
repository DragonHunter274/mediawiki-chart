apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "mediawiki.fullname" . }}
  labels:
    {{- include "mediawiki.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "mediawiki.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      annotations:
        configmap.reloader.stakater.com/reload: {{ printf "%s-localsettings" (include "mediawiki.fullname" .) | quote }}
        {{- with .Values.podAnnotations }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
      labels:
        {{- include "mediawiki.selectorLabels" . | nindent 8 }}
        {{- include "mediawiki.networkpolicy" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "mediawiki.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      initContainers:
        - name: mediawiki-db-init
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          envFrom:
          - secretRef:
              name: {{ include "mediawiki.fullname" . }}-secret
          command:
          - /bin/bash
          - -c
          - |
            set -e
            DB_HOST="{{ .Values.mediawiki.db.server | default (include "mediawiki.mariadb.fullname" .) }}"
            DB_PORT=3306
            DB_NAME="{{ .Values.mediawiki.db.name }}"
            DB_USER="${MW_DB_USER:-{{ .Values.mediawiki.db.user }}}"
            DB_PASS="${MW_DB_PASSWORD:-{{ .Values.mediawiki.db.password }}}"

            echo "Waiting for database at $DB_HOST:$DB_PORT..."
            until timeout 1 bash -c "cat < /dev/null > /dev/tcp/$DB_HOST/$DB_PORT" 2>/dev/null; do
              echo "Database not ready, retrying in 5s..."
              sleep 5
            done
            echo "Database TCP port is open."

            cd /var/www/html

            # Check if page table exists by attempting to describe it
            if mysql -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" -e "DESCRIBE page;" >/dev/null 2>&1; then
              echo "Tables found. Skipping install."
            else
              echo "No tables found. Running MediaWiki install..."
              php /var/www/html/maintenance/run.php install \
                --dbserver "$DB_HOST" \
                --dbname "$DB_NAME" \
                --dbuser "$DB_USER" \
                --dbpass "$DB_PASS" \
                --scriptpath "{{ .Values.mediawiki.scriptPath }}" \
                --lang "{{ .Values.mediawiki.languageCode }}" \
                --pass "$(openssl rand -base64 32)" \
                "{{ .Values.mediawiki.sitename }}" "Admin"
              echo "Install complete. Removing generated LocalSettings.php (using ConfigMap version)..."
              rm -f /var/www/html/LocalSettings.php
            fi
            echo "Database initialization complete."
      containers:
        - name: {{ .Chart.Name }}
          securityContext:
            {{- toYaml .Values.securityContext | nindent 12 }}
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          envFrom:
          - secretRef:
              name: {{ include "mediawiki.fullname" . }}-secret
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
          volumeMounts:
          - mountPath: /var/www/html/images
            name: {{ .Chart.Name }}-data
          - mountPath: /var/www/html/LocalSettings.php
            name: localsettings
            subPath: LocalSettings.php
      volumes:
      - name: {{ .Chart.Name }}-data
        persistentVolumeClaim:
          claimName: {{ .Chart.Name }}-data
      - name: localsettings
        configMap:
          name: {{ include "mediawiki.fullname" . }}-localsettings
